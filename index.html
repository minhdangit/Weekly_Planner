<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern Font */
        body { font-family: 'Quicksand', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Smooth inputs */
        .editable-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            transition: all 0.2s;
            width: 100%;
        }
        .editable-input:hover { background-color: rgba(0,0,0,0.03); }
        .editable-input:focus { 
            background-color: white; 
            border-color: #cbd5e1; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.2);
        }

        /* Checkbox Styling */
        input[type="checkbox"] {
            accent-color: #6366f1;
            width: 1.1em;
            height: 1.1em;
            cursor: pointer;
        }

        /* Scrollbar styles for horizontal scrolling */
        .horizontal-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .horizontal-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .horizontal-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Progress Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Hide specific elements on print */
        @media print {
            .no-print { display: none; }
            body { background: white; }
            .shadow-xl { box-shadow: none; }
            .horizontal-scroll { display: grid; grid-template-columns: repeat(2, 1fr); overflow: visible; }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const environmentConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- CẤU HÌNH CÁ NHÂN (Đã cập nhật thông tin của bạn) ---
        const myPersonalConfig = {
            apiKey: "AIzaSyBUdzp1OAl9rgZWxz7rMN9vqgz0UVTzEao",
            authDomain: "weekly-planner-ed5b9.firebaseapp.com",
            projectId: "weekly-planner-ed5b9",
            storageBucket: "weekly-planner-ed5b9.firebasestorage.app",
            messagingSenderId: "329024505726",
            appId: "1:329024505726:web:cdfcb93b5c85225bcdd52f",
            measurementId: "G-D67WE7KB3Y"
        };
        
        const firebaseConfig = environmentConfig || myPersonalConfig;
        const isConfigValid = firebaseConfig && firebaseConfig.apiKey;

        let db = null;
        let auth = null;
        const PLANNER_DOC_ID = 'my_custom_planner_v1';
        
        const plannerDocRefPath = (id) => {
             if (environmentConfig) return `artifacts/${appId}/public/data/weekly_planners/${id}`;
             return `weekly_planners/${id}`;
        };

        // --- Utils: Date Formatting DD/MM/YYYY ---
        const formatDate = (input) => {
            if (!input) return '';
            const date = typeof input === 'string' ? new Date(input) : input;
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        };

        const getDayDate = (startDateStr, dayIndex) => {
            const date = new Date(startDateStr);
            date.setDate(date.getDate() + dayIndex);
            return formatDate(date);
        };

        const createRing = (percent, color) => {
            const r = 40;
            const c = 2 * Math.PI * r;
            const offset = c - (percent / 100) * c;
            return `
                <svg width="100" height="100" class="block mx-auto">
                    <circle stroke="#f1f5f9" stroke-width="8" fill="transparent" r="${r}" cx="50" cy="50" />
                    <circle class="progress-ring__circle" stroke="${color}" stroke-width="8" stroke-linecap="round" 
                        stroke-dasharray="${c} ${c}" stroke-dashoffset="${offset}" fill="transparent" r="${r}" cx="50" cy="50" />
                    <text x="50" y="55" font-size="18" font-weight="bold" fill="${color}" text-anchor="middle">${percent}%</text>
                </svg>
            `;
        };

        // --- Firebase Init ---
        async function initFirebase() {
            if (!isConfigValid) {
                document.body.innerHTML = '<div class="p-10 text-center text-red-500">Chưa cấu hình Firebase. Vui lòng xem hướng dẫn.</div>';
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
            
            // Listen to data
            onSnapshot(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), (snap) => {
                const data = snap.data() || createDefaultData();
                if (!snap.exists()) setDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), data);
                renderApp(data);
            });
        }

        function createDefaultData() {
            const today = new Date().toISOString().split('T')[0];
            return {
                weekStart: today,
                habits: [
                    { id: 'h1', name: "Đọc sách 30p", done: Array(7).fill(false) },
                    { id: 'h2', name: "Uống 2L nước", done: Array(7).fill(false) }
                ],
                weekTasks: [], // Global tasks for the week
                days: {
                    monday: { mainFocus: "", notes: "", tasks: [] },
                    tuesday: { mainFocus: "", notes: "", tasks: [] },
                    wednesday: { mainFocus: "", notes: "", tasks: [] },
                    thursday: { mainFocus: "", notes: "", tasks: [] },
                    friday: { mainFocus: "", notes: "", tasks: [] },
                    saturday: { mainFocus: "", notes: "", tasks: [] },
                    sunday: { mainFocus: "", notes: "", tasks: [] },
                }
            };
        }

        // --- Render Logic ---
        function renderApp(data) {
            const app = document.getElementById('app');
            const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayLabels = ['Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy', 'Chủ Nhật'];
            const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ec4899', '#f97316', '#ef4444'];
            const bgColors = ['bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50', 'bg-pink-50', 'bg-orange-50', 'bg-red-50'];

            // Header & Sidebar
            let html = `
            <div class="h-screen flex flex-col lg:flex-row overflow-hidden bg-[#f8fafc]">
                
                <!-- Sidebar Control Panel (Fixed) -->
                <div class="lg:w-80 w-full flex-shrink-0 flex flex-col bg-white border-r border-slate-200 overflow-y-auto z-10 shadow-lg lg:shadow-none">
                    <div class="p-6 space-y-6">
                        <!-- Header App -->
                        <div class="pb-4 border-b border-slate-100">
                             <h1 class="text-2xl font-bold text-slate-800">Weekly Planner</h1>
                             <p class="text-xs text-slate-400">Kế hoạch tuần chuyên nghiệp</p>
                        </div>

                        <!-- Week Picker -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tuần bắt đầu</label>
                            <div class="relative">
                                <input type="date" value="${data.weekStart}" 
                                    onchange="updateField('weekStart', this.value)"
                                    class="w-full text-sm font-bold text-slate-700 bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 focus:border-blue-500 outline-none cursor-pointer">
                                <div class="mt-2 text-right text-sm font-bold text-blue-600">
                                    ${formatDate(data.weekStart)}
                                </div>
                            </div>
                        </div>

                        <!-- Habits Tracker -->
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Thói quen</h3>
                                <button onclick="addHabit()" class="text-slate-400 hover:text-blue-500 transition">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${data.habits.map((h, hIdx) => `
                                    <div class="group">
                                        <div class="flex items-center justify-between mb-2">
                                            <input type="text" value="${h.name}" 
                                                onchange="updateHabitName(${hIdx}, this.value)"
                                                class="editable-input font-medium text-slate-700 text-sm py-1 px-1"
                                                placeholder="Tên thói quen...">
                                            <button onclick="deleteHabit(${hIdx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        <div class="flex justify-between gap-1">
                                            ${h.done.map((isDone, dIdx) => `
                                                <div onclick="toggleHabit(${hIdx}, ${dIdx})" 
                                                    class="w-8 h-8 rounded-lg cursor-pointer transition-all flex items-center justify-center border-2 ${isDone ? 'bg-indigo-500 border-indigo-500 text-white shadow-sm' : 'bg-white border-slate-100 hover:border-indigo-300'}"
                                                    title="${dayLabels[dIdx]}">
                                                    ${isDone ? '<i data-lucide="check" class="w-4 h-4"></i>' : '<span class="text-[10px] font-bold text-slate-300">'+dayLabels[dIdx].charAt(4)+'</span>'}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Weekly Goals -->
                        <div>
                             <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Mục tiêu tuần</h3>
                                <button onclick="addGlobalTask()" class="text-slate-400 hover:text-blue-500 transition">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${data.weekTasks.map((t, tIdx) => `
                                    <div class="flex items-center gap-2 group bg-slate-50 p-2 rounded-lg border border-transparent hover:border-slate-200 transition-colors">
                                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleGlobalTask(${tIdx})">
                                        <input type="text" value="${t.text}" 
                                            onchange="updateGlobalTask(${tIdx}, this.value)"
                                            class="editable-input text-sm ${t.done ? 'line-through text-slate-400' : 'text-slate-700'}">
                                        <button onclick="deleteGlobalTask(${tIdx})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Calendar Horizontal Scroll Area -->
                <div class="flex-1 flex flex-col h-full overflow-hidden bg-[#f1f5f9]">
                    <div class="flex-1 horizontal-scroll overflow-x-auto overflow-y-hidden flex items-start gap-4 p-4 lg:p-8 snap-x snap-mandatory">
            `;

            // Daily Cards
            dayKeys.forEach((key, idx) => {
                const day = data.days[key];
                const total = day.tasks.length;
                const done = day.tasks.filter(t => t.done).length;
                const percent = total === 0 ? 0 : Math.round((done / total) * 100);
                const color = colors[idx];
                const dateStr = getDayDate(data.weekStart, idx);

                html += `
                        <div class="min-w-[85vw] md:min-w-[340px] lg:min-w-[320px] max-w-[400px] h-full snap-center bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0">
                            <!-- Daily Header -->
                            <div class="p-4 ${bgColors[idx]} border-b border-slate-100/50 text-center relative rounded-t-2xl">
                                <h4 class="font-bold text-lg" style="color: ${color}">${dayLabels[idx]}</h4>
                                <p class="text-xs font-bold text-slate-500 opacity-90 tracking-wide">${dateStr}</p>
                            </div>

                            <!-- Progress & Focus -->
                            <div class="p-4 flex flex-col items-center border-b border-slate-50">
                                <div class="mb-3 transform scale-90 hover:scale-100 transition-transform cursor-default" title="Hoàn thành ${done}/${total} việc">
                                    ${createRing(percent, color)}
                                </div>
                                
                                <div class="w-full bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1 text-center">Tiêu điểm (Focus)</label>
                                    <textarea onchange="updateDayField('${key}', 'mainFocus', this.value)"
                                        class="editable-input w-full text-sm font-bold text-slate-700 resize-none text-center bg-transparent focus:bg-white min-h-[40px]"
                                        rows="2" placeholder="Nhập tiêu điểm...">${day.mainFocus}</textarea>
                                </div>
                            </div>

                            <!-- Tasks List (Scrollable inside card) -->
                            <div class="flex-1 px-4 py-2 overflow-y-auto custom-scrollbar">
                                <div class="flex justify-between items-end mb-3 sticky top-0 bg-white z-10 py-2 border-b border-slate-50">
                                    <span class="text-xs font-bold text-slate-400 uppercase">Danh sách việc</span>
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">${done}/${total}</span>
                                </div>
                                <div class="space-y-2 pb-2">
                                    ${day.tasks.map((t, tIdx) => `
                                        <div class="flex items-start gap-3 group py-1.5 border-b border-slate-50 last:border-0">
                                            <input type="checkbox" ${t.done ? 'checked' : ''} 
                                                onchange="toggleTask('${key}', '${t.id}', this.checked)"
                                                class="mt-1 flex-shrink-0" style="accent-color: ${color}">
                                            <div class="flex-1 min-w-0">
                                                <input type="text" value="${t.text}" 
                                                    onchange="updateTaskText('${key}', '${t.id}', this.value)"
                                                    class="editable-input text-sm w-full ${t.done ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}">
                                            </div>
                                            <button onclick="deleteTask('${key}', '${t.id}')" 
                                                class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                                                <i data-lucide="x" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Quick Add -->
                                <div class="mt-2 flex items-center gap-2 text-slate-400 hover:text-blue-500 transition-colors cursor-text group pb-4"
                                     onclick="document.getElementById('add-input-${key}').focus()">
                                    <i data-lucide="plus" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                    <input type="text" id="add-input-${key}" placeholder="Thêm việc mới..." 
                                        onkeydown="if(event.key==='Enter'){addTask('${key}', this.value); this.value='';}"
                                        class="bg-transparent text-sm border-none focus:ring-0 w-full placeholder-slate-400 group-hover:placeholder-blue-300 text-slate-700">
                                </div>
                            </div>

                            <!-- Notes Footer -->
                            <div class="p-3 bg-slate-50 border-t border-slate-100 rounded-b-2xl">
                                <textarea onchange="updateDayField('${key}', 'notes', this.value)"
                                    class="w-full bg-transparent text-xs text-slate-600 resize-none border-none focus:ring-0 placeholder-slate-400"
                                    rows="2" placeholder="Ghi chú nhanh cho ${dayLabels[idx]}...">${day.notes}</textarea>
                            </div>
                        </div>
                `;
            });

            html += `
                    <!-- Spacer for easier scrolling -->
                    <div class="min-w-[20px] h-full flex-shrink-0"></div>
                    </div>
                </div>
            </div>`; 
            
            app.innerHTML = html;
            lucide.createIcons();
        }

        // --- Controller Actions ---

        window.updateField = async (field, value) => {
             await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [field]: value });
        };

        window.updateDayField = async (dayKey, field, value) => {
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [`days.${dayKey}.${field}`]: value });
        };

        // Habits
        window.addHabit = async () => {
            const snap = await getSnapshot();
            const habits = snap.data().habits || [];
            habits.push({ id: Date.now().toString(), name: "Thói quen mới", done: Array(7).fill(false) });
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { habits });
        };
        window.deleteHabit = async (idx) => {
            if(!confirm('Xóa thói quen này?')) return;
            const snap = await getSnapshot();
            const habits = snap.data().habits;
            habits.splice(idx, 1);
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { habits });
        };
        window.updateHabitName = async (idx, name) => {
            const snap = await getSnapshot();
            const habits = snap.data().habits;
            habits[idx].name = name;
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { habits });
        };
        window.toggleHabit = async (hIdx, dIdx) => {
            const snap = await getSnapshot();
            const habits = snap.data().habits;
            habits[hIdx].done[dIdx] = !habits[hIdx].done[dIdx];
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { habits });
        };

        // Weekly Tasks
        window.addGlobalTask = async () => {
             const snap = await getSnapshot();
             const weekTasks = snap.data().weekTasks || [];
             weekTasks.push({ id: Date.now().toString(), text: "Mục tiêu mới", done: false });
             await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { weekTasks });
        };
        window.deleteGlobalTask = async (idx) => {
             const snap = await getSnapshot();
             const weekTasks = snap.data().weekTasks;
             weekTasks.splice(idx, 1);
             await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { weekTasks });
        };
        window.updateGlobalTask = async (idx, text) => {
             const snap = await getSnapshot();
             const weekTasks = snap.data().weekTasks;
             weekTasks[idx].text = text;
             await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { weekTasks });
        };
        window.toggleGlobalTask = async (idx) => {
             const snap = await getSnapshot();
             const weekTasks = snap.data().weekTasks;
             weekTasks[idx].done = !weekTasks[idx].done;
             await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { weekTasks });
        };

        // Daily Tasks
        window.addTask = async (dayKey, text) => {
            if(!text.trim()) return;
            const snap = await getSnapshot();
            const tasks = snap.data().days[dayKey].tasks;
            tasks.push({ id: Date.now().toString(), text: text, done: false });
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [`days.${dayKey}.tasks`]: tasks });
        };
        window.deleteTask = async (dayKey, taskId) => {
            const snap = await getSnapshot();
            const tasks = snap.data().days[dayKey].tasks.filter(t => t.id !== taskId);
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [`days.${dayKey}.tasks`]: tasks });
        };
        window.updateTaskText = async (dayKey, taskId, newText) => {
            const snap = await getSnapshot();
            const tasks = snap.data().days[dayKey].tasks.map(t => t.id === taskId ? {...t, text: newText} : t);
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [`days.${dayKey}.tasks`]: tasks });
        };
        window.toggleTask = async (dayKey, taskId, isChecked) => {
            const snap = await getSnapshot();
            const tasks = snap.data().days[dayKey].tasks.map(t => t.id === taskId ? {...t, done: isChecked} : t);
            await updateDoc(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), { [`days.${dayKey}.tasks`]: tasks });
        };

        // Helper
        async function getSnapshot() {
             // Return promise of current doc data
             return new Promise(resolve => {
                 const unsub = onSnapshot(doc(db, plannerDocRefPath(PLANNER_DOC_ID)), (snap) => {
                     unsub(); // unsubscribe immediately, we just want one read
                     resolve(snap);
                 });
             });
        }

        window.onload = initFirebase;
    </script>
</head>
<body>
    <div id="app" class="min-h-screen">
        <div class="flex items-center justify-center h-screen text-slate-400">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>
</body>
</html>